From 2ade6dfe7fd4bc630c7d6b17f2556673a4d5e2bb Mon Sep 17 00:00:00 2001
From: Florin Postolache <florin.postolache80@gmail.com>
Date: Thu, 27 Oct 2022 09:50:31 +0300
Subject: [PATCH] Modify fflush-exit source to work with uktest

Signed-off-by: Florin Postolache <florin.postolache80@gmail.com>
---
 src/regression/fflush-exit.c | 11 ++++-------
 1 file changed, 4 insertions(+), 7 deletions(-)

diff --git a/src/regression/fflush-exit.c b/src/regression/fflush-exit.c
index 967f6af..2395be3 100644
--- a/src/regression/fflush-exit.c
+++ b/src/regression/fflush-exit.c
@@ -7,17 +7,16 @@
 #include <string.h>
 #include <unistd.h>
 #include <sys/wait.h>
-#include "test.h"
+#include <uk/test.h>
 
 #define ASSERT(c) do { \
 	errno = 0; \
-	if (!(c)) \
-		t_error("%s failed (errno: %s)\n", #c, strerror(errno)); \
+	UK_TEST_ASSERT((c)); \
 } while(0)
 
-int main(void)
+UK_TESTCASE(uk_libc_testsuite, fflush_exit_tests)
 {
-	char tmp[] = "/tmp/testsuite-XXXXXX";
+	char tmp[] = "/testsuite-XXXXXX";
 	int fd, pid, status;
 	char c;
 
@@ -27,12 +26,10 @@ int main(void)
 		ASSERT(close(1) == 0);
 		ASSERT(dup(fd) == 1);
 		ASSERT(fwrite("x", 1, 1, stdout) == 1);
-		exit(t_status);
 	}
 	ASSERT(waitpid(pid, &status, 0) == pid);
 	ASSERT(WIFEXITED(status) && WEXITSTATUS(status) == 0);
 	ASSERT(pread(fd, &c, 1, 0) == 1);
 	ASSERT(c == 'x');
 	ASSERT(unlink(tmp) == 0);
-	return t_status;
 }
-- 
2.25.1

