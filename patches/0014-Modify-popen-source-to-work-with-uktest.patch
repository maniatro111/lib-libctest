From d874eaecfce9994b20cd119aa35bbaf5d02039b2 Mon Sep 17 00:00:00 2001
From: Florin Postolache <florin.postolache80@gmail.com>
Date: Tue, 11 Oct 2022 08:46:57 +0300
Subject: [PATCH] Modify popen source to work with uktest

---
 src/functional/popen.c | 24 ++++++++++++------------
 1 file changed, 12 insertions(+), 12 deletions(-)

diff --git a/src/functional/popen.c b/src/functional/popen.c
index 42c32c4..ed2c24a 100644
--- a/src/functional/popen.c
+++ b/src/functional/popen.c
@@ -3,18 +3,18 @@
 #include <errno.h>
 #include <string.h>
 #include <signal.h>
-#include "test.h"
+#include <uk/test.h>//"test.h"
 
-#define TEST(r, f, x, m) ( \
-	((r) = (f)) == (x) || (t_error("%s failed (" m ")\n", #f, r, x), 0) )
+#define TEST(r, f, x, m) UK_TEST_ASSERT(((r) = (f)) == (x))//( \
+//	((r) = (f)) == (x) || (t_error("%s failed (" m ")\n", #f, r, x), 0) )
 
-#define TEST_E(f) ( \
-	(errno = 0), \
-	(f) || (t_error("%s failed (errno = %d)\n", #f, errno), 0) )
+#define TEST_E(f) UK_TEST_EXPECT_SNUM_GE((f), 0)//( \
+//	(errno = 0), \
+//	(f) || (t_error("%s failed (errno = %d)\n", #f, errno), 0) )
 
-#define TEST_S(s, x, m) ( \
-	!strcmp((s),(x)) || \
-		(t_error("[%s] != [%s] (%s)\n", s, x, m), 0) )
+#define TEST_S(s, x, m) UK_TEST_EXPECT_ZERO(strcmp((s),(x)))//( \
+//	!strcmp((s),(x)) || \
+//		(t_error("[%s] != [%s] (%s)\n", s, x, m), 0) )
 
 static sig_atomic_t got_sig;
 
@@ -22,7 +22,7 @@ static void handler(int sig) {
 	got_sig = 1;
 }
 
-int main(void)
+UK_TESTCASE(uk_libc_testsuite, popen_tests)//int main(void)
 {
 	int i;
 	char foo[6];
@@ -40,10 +40,10 @@ int main(void)
 	snprintf(cmd, sizeof cmd, "read a ; test \"x$a\" = xhello && kill -USR1 %d", getpid());
 	TEST_E(f = popen(cmd, "w"));
 	if (f) {
-		TEST_E(fputs("hello", f) >= 0);
+		TEST_E(fputs("hello", f));
 		TEST(i, pclose(f), 0, "exit status %04x != %04x");
 		TEST(i, got_sig, 1, "child process did not send signal");
 	}
 	signal(SIGUSR1, SIG_DFL);
-	return t_status;
+//	return t_status;
 }
-- 
2.25.1

