From 2891574e4d6dc78839b7ea7162b19fa718a464b5 Mon Sep 17 00:00:00 2001
From: Florin Postolache <florin.postolache80@gmail.com>
Date: Tue, 25 Oct 2022 00:10:07 +0300
Subject: [PATCH] Modify string_memcpy source to work with uktest

Signed-off-by: Florin Postolache <florin.postolache80@gmail.com>
---
 src/functional/string_memcpy.c | 16 +++++++---------
 1 file changed, 7 insertions(+), 9 deletions(-)

diff --git a/src/functional/string_memcpy.c b/src/functional/string_memcpy.c
index 96256a7..92e3ac4 100644
--- a/src/functional/string_memcpy.c
+++ b/src/functional/string_memcpy.c
@@ -1,7 +1,7 @@
 #include <string.h>
 #include <stdlib.h>
 #include <stdint.h>
-#include "test.h"
+#include <uk/test.h>
 
 static char buf[512];
 
@@ -12,7 +12,7 @@ static void *aligned(void *p) {
 }
 
 #define N 80
-static void test_align(int dalign, int salign, int len)
+static int test_align(int dalign, int salign, int len)
 {
 	char *src = aligned(buf);
 	char *dst = aligned(buf + 128);
@@ -30,17 +30,16 @@ static void test_align(int dalign, int salign, int len)
 		src[salign+i] = want[dalign+i] = '0'+i;
 	p = pmemcpy(dst+dalign, src+salign, len);
 	if (p != dst+dalign)
-		t_error("memcpy(%p,...) returned %p\n", dst+dalign, p);
+		return 1;
 	for (i = 0; i < N; i++)
 		if (dst[i] != want[i]) {
-			t_error("memcpy(align %d, align %d, %d) failed\n", dalign, salign, len);
-			t_printf("got : %.*s\n", dalign+len+1, dst);
-			t_printf("want: %.*s\n", dalign+len+1, want);
+			return 2;
 			break;
 		}
+	return 0;
 }
 
-int main(void)
+UK_TESTCASE(uk_libc_testsuite, string_memcpy_tests)
 {
 	int i,j,k;
 
@@ -49,7 +48,6 @@ int main(void)
 	for (i = 0; i < 16; i++)
 		for (j = 0; j < 16; j++)
 			for (k = 0; k < 64; k++)
-				test_align(i,j,k);
+				UK_TEST_EXPECT_ZERO(test_align(i,j,k));
 
-	return t_status;
 }
-- 
2.25.1

